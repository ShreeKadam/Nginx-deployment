pipeline {
  agent any

  environment {
    AWS_DEFAULT_REGION = 'us-east-1'
  }

  stages {
    stage('Terraform Init & Apply') {
      steps {
        dir('terraform') {
          sh 'terraform init'
          sh 'terraform apply -auto-approve'
        }
      }
    }

    stage('Get Bastion IP') {
      steps {
        script {
          bastion_ip = sh(script: 'terraform output -raw bastion_public_ip', returnStdout: true).trim()
          writeFile file: 'ansible/ansible.cfg', text: library.replaceInFile(readFile('ansible/ansible.cfg'), '<BASTION_PUBLIC_IP>', bastion_ip)
        }
      }
    }

    stage('Install Python deps') {
      steps {
        sh 'pip install -r ansible/requirements.txt'
      }
    }

    stage('Run Ansible Playbook') {
      steps {
        dir('ansible') {
          sh 'ansible-playbook nginx.yml'
        }
      }
    }
  }
}
